<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Plan ‚Äî CoreHabit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Premium feature flag (TEMP ‚Äì legacy, ignored now) -->
  <script>
    window.PREMIUM_ENABLED = true;
  </script>

  <!-- STEP 3: Capture Stripe session_id after checkout -->
  <script>
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get("session_id");

    if (sessionId) {
      localStorage.setItem("corehabit_session_id", sessionId);
    }
  </script>

  <!-- Styles -->
  <link rel="stylesheet" href="./assets/styles.css">
  <link rel="stylesheet" href="./assets/premium.css">
</head>

<body style="
  min-height:100vh;
  background: radial-gradient(
    80% 80% at 20% 10%,
    #1a1f35 0%,
    #0b0f19 60%
  );
  color:#ffffff;
">

  <!-- PAGE CONTAINER -->
  <div style="max-width:720px;margin:80px auto;padding:20px;font-family:system-ui;">

    <h1>Your Personalized Plan</h1>
    <p style="color:#9ca3af;">
      Based on your answers, here‚Äôs your CoreHabit plan.
    </p>

    <!-- STATUS -->
    <p id="status" style="margin-top:20px;font-weight:600;"></p>

    <!-- BUTTONS -->
    <div style="margin-top:20px;">
      <button id="generateBtn" onclick="generatePlan()" style="
        padding:14px 22px;
        border-radius:999px;
        border:none;
        background:#7c5cff;
        color:white;
        font-weight:700;
        font-size:16px;
        cursor:pointer;
      ">
        Generate My Plan
      </button>

      <button id="regenBtn" onclick="generatePlan()" style="
        margin-left:12px;
        padding:12px 20px;
        border-radius:999px;
        border:1px solid #7c5cff;
        background:transparent;
        color:#7c5cff;
        font-weight:600;
        font-size:14px;
        cursor:pointer;
        display:none;
      ">
        Regenerate Plan
      </button>
    </div>

    <!-- FREE PLAN -->
    <div id="result" style="
      margin-top:40px;
      padding:32px;
      background:#111827;
      color:#e5e7eb;
      border-radius:20px;
      box-shadow:0 20px 40px rgba(0,0,0,0.4);
      display:none;
    "></div>

    <!-- ======================
         PREMIUM SECTION
         ====================== -->
    <div id="premium-root" style="margin-top:56px;">

      <h2 class="premium-title">CoreHabit Premium</h2>

      <p class="premium-subtitle">
        Everything you need to accelerate results ‚Äî personalized and adaptive.
      </p>

      <div class="premium-lock-wrapper">

        <div class="premium-card">
          <h3>üõí Budget-Based Grocery List</h3>
          <p>
            Weekly groceries auto-generated to match your calories,
            macros, and budget level.
          </p>
        </div>

        <div class="premium-card">
          <h3>üçΩÔ∏è 7-Day Meal Plan</h3>
          <p>
            A full week of meals built from your targets and preferences,
            updated as your plan changes.
          </p>
        </div>

        <div class="premium-card">
          <h3>üèãÔ∏è Targeted Muscle Group Workouts</h3>
          <p>
            Optional muscle focus programming that adapts your training
            without sacrificing balance.
          </p>
        </div>

        <div class="premium-card">
          <h3>üìä Macro Targets & Progress Tracking</h3>
          <p>
            Exact calorie and macro targets with ongoing progress tracking.
          </p>
        </div>

        <div class="premium-card">
          <h3>üîÅ Weekly Check-Ins & Plan Updates</h3>
          <p>
            Weekly feedback and automatic plan adjustments based on results.
          </p>
        </div>

        <!-- LOCK OVERLAY -->
        <div class="premium-locked-overlay">
          <h3>Unlock CoreHabit Premium</h3>
          <p>
            Get grocery lists, meal plans, advanced workouts,
            and progress tracking personalized to you.
          </p>
          <a href="/premium.html" class="premium-primary-btn">
            Upgrade to Premium
          </a>
        </div>

      </div>

      <!-- Manage Subscription -->
      <div class="premium-manage-wrapper">
        <button
          class="premium-secondary-btn premium-manage-btn"
          onclick="openCustomerPortal()">
          Manage Subscription
        </button>
      </div>

    </div>

  </div>

  <!-- üîî Premium unlock toast -->
  <div id="premium-toast" aria-live="polite">
    ‚ú® Premium Unlocked
  </div>

  <!-- Core logic -->
  <script>
    async function generatePlan() {
      const statusEl = document.getElementById("status");
      const resultEl = document.getElementById("result");
      const generateBtn = document.getElementById("generateBtn");
      const regenBtn = document.getElementById("regenBtn");

      generateBtn.disabled = true;
      generateBtn.textContent = "Generating...";
      statusEl.textContent = "Creating a fresh CoreHabit plan...";
      resultEl.style.display = "none";
      resultEl.innerHTML = "";

      const onboardingRaw = localStorage.getItem("corehabit_onboarding");

      if (!onboardingRaw) {
        statusEl.textContent = "No onboarding data found.";
        generateBtn.disabled = false;
        generateBtn.textContent = "Generate My Plan";
        return;
      }

      const onboarding = JSON.parse(onboardingRaw);

      try {
        const response = await fetch("/.netlify/functions/generatePlan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ onboarding })
        });

        const data = await response.json();

        statusEl.textContent = "";
        resultEl.style.display = "block";

        resultEl.innerHTML = `
          <section style="margin-bottom:32px;">
            <h2>Your CoreHabit Plan</h2>
            <p>${data.overview || "Your personalized plan is ready."}</p>
          </section>

          ${data.weekly_workout_split ? `
          <section style="margin-bottom:24px;">
            <h3>Weekly Workout Split</h3>
            <ul>
              ${data.weekly_workout_split.map(day => `<li>${day}</li>`).join("")}
            </ul>
          </section>` : ""}

          ${data.sample_workout ? `
          <section style="margin-bottom:24px;">
            <h3>Sample Workout</h3>
            <ul>
              ${data.sample_workout.map(item => `<li>${item}</li>`).join("")}
            </ul>
          </section>` : ""}

          ${data.daily_nutrition_guidelines ? `
          <section style="margin-bottom:24px;">
            <h3>Daily Nutrition Guidelines</h3>
            <ul>
              ${data.daily_nutrition_guidelines.map(item => `<li>${item}</li>`).join("")}
            </ul>
          </section>` : ""}

          ${data.sample_day_of_eating ? `
          <section style="margin-bottom:24px;">
            <h3>Sample Day of Eating</h3>
            <ul>
              ${data.sample_day_of_eating.map(item => `<li>${item}</li>`).join("")}
            </ul>
          </section>` : ""}

          ${data.weekly_focus_tip ? `
          <section style="margin-bottom:24px;">
            <h3>Weekly Focus Tip</h3>
            <p>${data.weekly_focus_tip}</p>
          </section>` : ""}
        `;

        regenBtn.style.display = "inline-block";

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Something went wrong generating your plan.";
      }

      generateBtn.disabled = false;
      generateBtn.textContent = "Generate My Plan";
    }
  </script>

  <!-- Premium status check -->
  <script>
    async function checkPremiumStatus() {
      const sessionId = localStorage.getItem("corehabit_session_id");
      if (!sessionId) return false;

      try {
        const res = await fetch("/.netlify/functions/checkPremium", {
          method: "POST",
          body: JSON.stringify({ sessionId }),
        });
        const data = await res.json();
        return data.isPremium === true;
      } catch (err) {
        console.error("Premium check failed:", err);
        return false;
      }
    }

    checkPremiumStatus().then(isPremium => {
      const wasPremium = document.body.classList.contains("is-premium");
      document.body.classList.toggle("is-premium", isPremium);

      if (isPremium && !wasPremium) {
        const toast = document.getElementById("premium-toast");
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
      }
    });
  </script>

  <!-- Customer Portal redirect -->
  <script>
    async function openCustomerPortal() {
      const customerId = localStorage.getItem("corehabit_customer_id");

      if (!customerId) {
        alert("Unable to load subscription details.");
        return;
      }

      const res = await fetch("/.netlify/functions/createPortalSession", {
        method: "POST",
        body: JSON.stringify({ customerId }),
      });

      const data = await res.json();

      if (data.url) {
        window.location.href = data.url;
      }
    }
  </script>

</body>
</html>
