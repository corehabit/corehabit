<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Plan â€” CoreHabit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/styles.css">
</head>

<body style="
  min-height:100vh;
  background: radial-gradient(80% 80% at 20% 10%, #1a1f35 0%, #0b0f19 60%) !important;
  color:#ffffff;
">

  <div style="max-width:720px;margin:80px auto;padding:20px;font-family:system-ui;">

    <h1>Your Personalized Plan</h1>
    <p style="color:#9ca3af;">
      Based on your answers, hereâ€™s your CoreHabit plan.
    </p>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" id="tab-plan" onclick="showTab('plan')">Plan</div>
      <div class="tab locked" id="tab-grocery" onclick="openUpgradeModal('grocery')">
        Grocery List <span class="lock-pill">ğŸ”’ Premium</span>
      </div>
      <div class="tab locked" id="tab-budget" onclick="openUpgradeModal('budget')">
        Budget <span class="lock-pill">ğŸ”’ Premium</span>
      </div>
    </div>

    <!-- STATUS -->
    <p id="status" style="margin-top:10px;font-weight:600;"></p>

    <!-- BUTTONS -->
    <div style="margin-top:14px;">
      <button id="generateBtn" onclick="generatePlan()" style="
        padding:14px 22px;
        border-radius:999px;
        border:none;
        background:#7c5cff;
        color:white;
        font-weight:700;
        font-size:16px;
        cursor:pointer;
      ">
        Generate My Plan
      </button>

      <button id="regenBtn" onclick="generatePlan()" style="
        margin-left:12px;
        padding:12px 20px;
        border-radius:999px;
        border:1px solid #7c5cff;
        background:transparent;
        color:#7c5cff;
        font-weight:600;
        font-size:14px;
        cursor:pointer;
        display:none;
      ">
        Regenerate Plan
      </button>
    </div>

    <!-- PLAN CARD -->
    <div id="result" style="
      margin-top:40px;
      padding:32px;
      background:#111827;
      color:#e5e7eb;
      border-radius:20px;
      box-shadow:0 20px 40px rgba(0,0,0,0.4);
      display:none;
    "></div>

  </div>

  <!-- Premium Upgrade Modal -->
  <div class="modal-overlay" id="premiumModalOverlay" onclick="overlayClickClose(event)">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="premiumTitle">
      <div class="modal-header">
        <div>
          <p class="modal-title" id="premiumTitle">Upgrade to CoreHabit Premium</p>
          <p class="modal-subtitle"><strong>$14.99/month</strong> Â· Cancel anytime</p>
        </div>
        <button class="modal-close" onclick="closeUpgradeModal()" aria-label="Close">âœ•</button>
      </div>

      <div class="modal-body">
        <div style="color:#cbd5e1;font-weight:700;">
          Free: â€œHereâ€™s what to do.â€<br/>
          Premium: â€œHereâ€™s how to actually do it â€” affordably.â€
        </div>

        <ul class="modal-bullets">
          <li>ğŸ›’ Get a weekly <strong>grocery list</strong> from your plan</li>
          <li>ğŸ’µ Choose a <strong>budget mode</strong> (low-cost, balanced, flexible)</li>
          <li>ğŸ’ª Optionally <strong>focus a muscle group</strong> (glutes, arms, chest, etc.)</li>
          <li>ğŸ” <strong>Unlimited</strong> plan regenerations</li>
        </ul>

        <div id="premiumContext" style="margin-top:14px;color:#cbd5e1;font-weight:700;"></div>
      </div>

      <div class="modal-footer">
        <button class="modal-primary" onclick="upgradeClicked()">Upgrade to Premium</button>
        <button class="modal-secondary" onclick="closeUpgradeModal()">Keep Free Plan</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Tabs (free users only get Plan; locked tabs open modal) ---------- */
function showTab(tabName) {
  // Only Plan is available in free right now.
  document.getElementById("tab-plan").classList.add("active");
  // If you later implement premium tabs, this is where youâ€™d switch content.
}

/* ---------- Premium Modal ---------- */
function openUpgradeModal(source) {
  const overlay = document.getElementById("premiumModalOverlay");
  const ctx = document.getElementById("premiumContext");

  if (source === "grocery") {
    ctx.textContent = "Unlock Grocery List: turn your plan into a ready-to-shop list each week.";
  } else if (source === "budget") {
    ctx.textContent = "Unlock Budget: get low-cost swaps and budget modes that fit your lifestyle.";
  } else if (source === "focus") {
    ctx.textContent = "Unlock Muscle Focus: emphasize one area (glutes, arms, chest, etc.) while staying balanced.";
  } else {
    ctx.textContent = "";
  }

  overlay.style.display = "flex";
}

function closeUpgradeModal() {
  document.getElementById("premiumModalOverlay").style.display = "none";
}

function overlayClickClose(e) {
  if (e.target.id === "premiumModalOverlay") closeUpgradeModal();
}

function upgradeClicked() {
  // Placeholder for Stripe/checkout later
  alert("Premium checkout is coming next. This button will take users to payment.");
  closeUpgradeModal();
}

/* ---------- Plan Generation ---------- */
async function generatePlan() {
  const statusEl = document.getElementById("status");
  const resultEl = document.getElementById("result");
  const generateBtn = document.getElementById("generateBtn");
  const regenBtn = document.getElementById("regenBtn");

  generateBtn.disabled = true;
  generateBtn.textContent = "Generating...";
  statusEl.textContent = "Creating a fresh CoreHabit plan...";
  resultEl.style.display = "none";
  resultEl.innerHTML = "";

  const onboardingRaw = localStorage.getItem("corehabit_onboarding");
  if (!onboardingRaw) {
    statusEl.textContent = "No onboarding data found.";
    generateBtn.disabled = false;
    generateBtn.textContent = "Generate My Plan";
    return;
  }

  const onboarding = JSON.parse(onboardingRaw);

  try {
    const response = await fetch("/.netlify/functions/generatePlan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ onboarding })
    });

    const data = await response.json();

    statusEl.textContent = "";
    resultEl.style.display = "block";

    resultEl.innerHTML = `
      <section style="margin-bottom:32px;">
        <h2 style="font-size:22px;margin-bottom:10px;">Overview</h2>
        <p style="line-height:1.7;">${data.overview}</p>
      </section>

      <section style="margin-bottom:32px;">
        <h2 style="font-size:22px;margin-bottom:10px;">Weekly Workout Split</h2>
        <ul style="padding-left:20px;">
          ${data.weekly_workout_split.map(i => `<li style="margin-bottom:8px;">${i}</li>`).join("")}
        </ul>
      </section>

      <section style="margin-bottom:32px;">
        <h2 style="font-size:22px;margin-bottom:10px;">Sample Workout</h2>
        <ul style="padding-left:20px;">
          ${data.sample_workout.map(i => `<li style="margin-bottom:8px;">${i}</li>`).join("")}
        </ul>
      </section>

      <section style="margin-bottom:32px;">
        <h2 style="font-size:22px;margin-bottom:10px;">Daily Nutrition Guidelines</h2>
        <ul style="padding-left:20px;">
          ${data.daily_nutrition_guidelines.map(i => `<li style="margin-bottom:8px;">${i}</li>`).join("")}
        </ul>
      </section>

      <section style="margin-bottom:32px;">
        <h2 style="font-size:22px;margin-bottom:10px;">Sample Day of Eating</h2>
        <ul style="padding-left:20px;">
          ${data.sample_day_of_eating.map(i => `<li style="margin-bottom:8px;">${i}</li>`).join("")}
        </ul>
      </section>

      <section>
        <h2 style="font-size:22px;margin-bottom:10px;">Weekly Focus</h2>
        <p style="line-height:1.7;">${data.weekly_focus_tip}</p>
      </section>
    `;

    generateBtn.disabled = false;
    generateBtn.textContent = "Generate My Plan";
    regenBtn.style.display = "inline-block";

  } catch (err) {
    statusEl.textContent = "Something went wrong.";
    resultEl.style.display = "block";
    resultEl.textContent = err.message;
    generateBtn.disabled = false;
    generateBtn.textContent = "Generate My Plan";
  }
}
</script>

</body>
</html>
