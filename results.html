<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Plan ‚Äî CoreHabit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Premium feature flag (TEMP ‚Äì legacy, ignored now) -->
  <script>
    window.PREMIUM_ENABLED = true;
  </script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const { createClient } = supabase;

  window.supabaseClient = window.supabaseClient || createClient(
    "https://wonbwlvnojtgydvpllmk.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvbmJ3bHZub2p0Z3lkdnBsbG1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NjExNjgsImV4cCI6MjA4NjIzNzE2OH0.AmWxx4I8t6MF2yo8FEv4CtMDlooASeg9Cy17fm_tslo"
  );
</script>  <!-- Capture Stripe session_id after checkout -->
  
 <script>
document.addEventListener("DOMContentLoaded", async () => {

  const supabase = window.supabaseClient;
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) return; // allow free access

  const { data: profile } = await supabase
    .from("profiles")
    .select("premium_status")
    .eq("id", user.id)
    .single();

  if (profile?.premium_status === true) {
    unlockPremiumUI();
  }

});
</script>
  
<script>
  const params = new URLSearchParams(window.location.search);
  const sessionId = params.get("session_id");

  if (sessionId) {
    localStorage.setItem("corehabit_session_id", sessionId);

    fetch("/.netlify/functions/getCustomerFromSession", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId })
    })
      .then(res => res.json())
      .then(async data => {
  if (data.customerId) {

  const supabase = window.supabaseClient;

  const { data: sessionData } = await supabase.auth.getSession();

  if (sessionData?.session?.user) {

    const userId = sessionData.session.user.id;

    await supabase
      .from("profiles")
      .update({ premium_status: true })
      .eq("id", userId);
  }

  window.location.href = "/results.html";
        }
  })
  .catch(err => console.error(err));
}

     
</script>
     


  <!-- Styles -->
  <link rel="stylesheet" href="./assets/styles.css">
  <link rel="stylesheet" href="./assets/premium.css">
  <style>
.auth-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.auth-box {
  background: #111827;
  padding: 40px;
  border-radius: 20px;
  width: 320px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.auth-box input {
  padding: 14px;
  border-radius: 10px;
  border: none;
  background: #1f2937;
  color: white;
}

.auth-box button {
  padding: 14px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(135deg, #7c5cff, #9b87ff);
  color: white;
  font-weight: 700;
  cursor: pointer;
}
</style>
</head>

<body class="corehabit-body">

<div style="
  max-width:760px;
  margin:96px auto 120px auto;
  padding:28px;
  font-family:system-ui;
">

  <h1 style="
  font-size:42px;
  font-weight:800;
  letter-spacing:-0.02em;
  margin-bottom:14px;
">
  Your Personalized Plan
</h1>
  <button
  id="regenBtn"
  onclick="goToPremiumOnboarding()"
 style="
    display:none;
    margin-top:28px;
    width:100%;
    padding:20px;
    border-radius:999px;
    border:none;
    background: linear-gradient(135deg, #d4af37, #f0d58c);
    color:#1a1a1a;
    font-weight:800;
    font-size:18px;
    letter-spacing:0.03em;
    cursor:pointer;
    box-shadow:0 15px 40px rgba(212,175,55,0.45);
    transition: all 0.2s ease;
  "
  onmouseover="this.style.transform='translateY(-2px)'"
  onmouseout="this.style.transform='translateY(0)'"
>
  üîÅ Regenerate Premium Plan
</button>
  <p style="
  color:#9ca3af;
  font-size:18px;
  margin-bottom:32px;
">
    Based on your answers, here‚Äôs your CoreHabit plan.
  </p>

  <p id="status" style="margin-top:20px;font-weight:600;"></p>

  <div style="
  margin-top:28px;
  display:flex;
  justify-content:center;
">
    <button id="generateBtn" onclick="generatePlan()" style="
  padding:20px 42px;
  border-radius:999px;
  border:none;
  background: linear-gradient(135deg, #7c5cff, #9b87ff);
  color:white;
  font-weight:800;
  font-size:18px;
  cursor:pointer;
  box-shadow: 0 18px 40px rgba(124,92,255,0.45);
  transition: all 0.18s ease;
"
onmouseover="this.style.transform='translateY(-2px)'"
onmouseout="this.style.transform='translateY(0)'"
>
  Generate My Plan
</button>

   
  </div>

  <div id="result" style="
    border: 1px solid rgba(124,92,255,0.18);
backdrop-filter: blur(6px);
    margin-top:40px;
    padding:32px;
    background:#111827;
    color:#e5e7eb;
    border-radius:20px;
    box-shadow:0 20px 40px rgba(0,0,0,0.4);
    display:none;
  "></div>
<section id="premium-sections" style="display:none;">

  <div class="premium-card">
    <h3>7-Day Meal Plan</h3>
    <ul id="seven-day-meal-plan"></ul>
  </div>

  <div class="premium-card">
    <h3>Grocery List</h3>
    <ul id="grocery-list"></ul>
  </div>

  <div class="premium-card">
    <h3>Weekly Check-In</h3>
    <p id="weekly-check-in"></p>
  </div>

  <div class="premium-card">
    <h3>Advanced Training Notes</h3>
    <p id="advanced-training-notes"></p>
  </div>

</section>  <!-- PREMIUM -->
  <div id="premium-root" style="margin-top:56px;">

    <h2 class="premium-title">
  CoreHabit Premium
  <span
    id="premium-badge"
    style="
      margin-left:10px;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      background:#7c5cff;
      color:white;
      display:none;
    "
  >
    ACTIVE
  </span>
</h2>
    <p class="premium-subtitle">
      Everything you need to accelerate results ‚Äî personalized and adaptive.
    </p>

    <div class="premium-lock-wrapper">

      <div class="premium-card">
  <h3>üõí Grocery Lists</h3>
  <p style="color:#9ca3af;font-size:14px;margin-top:6px;">
    Budget-based weekly grocery lists auto-generated from your calories and macros.
  </p>
</div>

<div class="premium-card">
  <h3>üçΩÔ∏è 7-Day Meal Plans</h3>
  <p style="color:#9ca3af;font-size:14px;margin-top:6px;">
    A full week of meals built from your goals and preferences, updated as your plan evolves.
  </p>
</div>

<div class="premium-card">
  <h3>üèãÔ∏è Muscle Focus Workouts</h3>
  <p style="color:#9ca3af;font-size:14px;margin-top:6px;">
    Optional muscle-group focus programming that adapts your training without sacrificing balance.
  </p>
</div>

<div class="premium-card">
  <h3>üìä Macro Targets</h3>
  <p style="color:#9ca3af;font-size:14px;margin-top:6px;">
    Exact calorie and macro targets with built-in progress tracking.
  </p>
</div>

<div class="premium-card">
  <h3>üîÅ Weekly Updates</h3>
  <p style="color:#9ca3af;font-size:14px;margin-top:6px;">
    Automatic weekly plan adjustments based on your progress and check-ins.
  </p>
</div>

      <div class="premium-locked-overlay">
        <h3>Unlock CoreHabit Premium</h3>
        <p>Advanced plans, meals, groceries, and progress tracking.</p>

        <!-- ORIGINAL BUTTON (KEPT ‚Äî NOT REMOVED) -->
       <div
  style="
    display:flex;
    justify-content:center;
    gap:16px;
    margin-top:24px;
    flex-wrap:wrap;
  "
>
  <button
  class="premium-primary-btn"
  onclick="startPremiumFlow('monthly')"
  style="min-width:220px;"
>
  Go Premium ‚Äî Monthly
</button>

<button
  class="premium-primary-btn"
  onclick="startPremiumFlow('annual')"
  style="min-width:220px;"
>
  Go Premium ‚Äî Annual
</button>
</div>
        

      </div>

    </div>

  </div>

</div>

<div id="premium-toast" aria-live="polite">‚ú® Premium Unlocked</div>

<!-- ========================= -->
<!-- Generate Plan -->
<!-- ========================= -->
  <script>
    const urlParams2 = new URLSearchParams(window.location.search);

if (urlParams2.get("premium") === "success") {
  localStorage.setItem("corehabit_premium", "true");
}
async function generatePlan() {

  const isRegenerating =
  document.activeElement &&
  document.activeElement.id === "regenBtn";


  const statusEl = document.getElementById("status");
  const resultEl = document.getElementById("result");
  const generateBtn = document.getElementById("generateBtn");
  const regenBtn = document.getElementById("regenBtn");


  if (generateBtn) generateBtn.disabled = true;
  if (regenBtn) regenBtn.disabled = true;

  statusEl.textContent = isRegenerating
    ? "Refreshing your Premium plan..."
    : "Creating your CoreHabit plan...";

  resultEl.style.display = "none";
  resultEl.innerHTML = "";

  const onboardingRaw = localStorage.getItem("corehabit_onboarding");
  if (!onboardingRaw) {
    statusEl.textContent = "No onboarding data found.";
    if (generateBtn) generateBtn.disabled = false;
    if (regenBtn) regenBtn.disabled = false;
    return;
  }

  try {

    // ‚úÖ Check if user is premium
    const supabase = window.supabaseClient;
    const { data: { user } } = await supabase.auth.getUser();

    let isPremium = false;

    if (user) {
      const { data: profile } = await supabase
        .from("profiles")
        .select("premium_status")
        .eq("id", user.id)
        .single();

      isPremium = profile?.premium_status === true;
    }

    // ‚úÖ Call backend
    const response = await fetch("/.netlify/functions/generatePlan", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    onboarding: JSON.parse(onboardingRaw),
    isPremium: isPremium
  })
});

if (!response.ok) {
  const errorText = await response.text();
  console.error("Server error:", errorText);
  throw new Error("Server failed");
}

const raw = await response.json();
console.log("API RESPONSE:", raw);

if (!raw.plan) {
  console.error("No plan returned:", raw);
  throw new Error("Plan missing");
}

const data = raw.plan;
    // ‚úÖ Render base plan
    resultEl.style.display = "block";
    resultEl.innerHTML = `
      <section><h2>Your CoreHabit Plan</h2><p>${data.overview}</p></section>
      <section><h3>Weekly Workout Split</h3><ul>${data.weekly_workout_split.map(d=>`<li>${d}</li>`).join("")}</ul></section>
      <section><h3>Sample Workout</h3><ul>${data.sample_workout.map(i=>`<li>${i}</li>`).join("")}</ul></section>
      <section><h3>Daily Nutrition Guidelines</h3><ul>${data.daily_nutrition_guidelines.map(i=>`<li>${i}</li>`).join("")}</ul></section>
      <section><h3>Sample Day of Eating</h3><ul>${data.sample_day_of_eating.map(i=>`<li>${i}</li>`).join("")}</ul></section>
      <section><h3>Weekly Focus Tip</h3><p>${data.weekly_focus_tip}</p></section>
    `;

    // ‚úÖ Render premium ONLY if premium
    if (isPremium) {

      const premiumSections = document.getElementById("premium-sections");

      if (data.macro_targets) {
        const macroHTML = `
          <div class="premium-card">
            <h3>Macro Targets</h3>
            <ul>
              <li><strong>Calories:</strong> ${data.macro_targets.calories}</li>
              <li><strong>Protein:</strong> ${data.macro_targets.protein}g</li>
              <li><strong>Carbs:</strong> ${data.macro_targets.carbs}g</li>
              <li><strong>Fats:</strong> ${data.macro_targets.fats}g</li>
            </ul>
          </div>
        `;
        premiumSections.insertAdjacentHTML("afterbegin", macroHTML);
      }
      // Fill 7-Day Meal Plan
if (data.seven_day_meal_plan) {
  document.getElementById("seven-day-meal-plan").innerHTML =
    data.seven_day_meal_plan.map(i => `<li>${i}</li>`).join("");
}

// Fill Grocery List
if (data.grocery_list) {
  document.getElementById("grocery-list").innerHTML =
    data.grocery_list.map(i => `<li>${i}</li>`).join("");
}

// Fill Weekly Check-In
if (data.weekly_check_in) {
  document.getElementById("weekly-check-in").textContent =
    data.weekly_check_in;
}

// Fill Advanced Training Notes
if (data.advanced_training_notes) {
  document.getElementById("advanced-training-notes").textContent =
    data.advanced_training_notes;
}

      if (data.volume_targets) {
        premiumSections.insertAdjacentHTML("beforeend", `
          <div class="premium-card">
            <h3>Weekly Volume Targets</h3>
            <ul>
              ${data.volume_targets.map(v => `<li>${v}</li>`).join("")}
            </ul>
          </div>
        `);
      }

      if (data.progression_strategy) {
        premiumSections.insertAdjacentHTML("beforeend", `
          <div class="premium-card">
            <h3>Progression Strategy</h3>
            <p>${data.progression_strategy}</p>
          </div>
        `);
      }

      if (data.full_week_workout_plan) {

  let workoutHTML = `
    <div class="premium-card">
      <h3>Full 7-Day Training Plan</h3>
  `;

  for (const day in data.full_week_workout_plan) {
    workoutHTML += `
      <h4 style="margin-top:16px;">${day}</h4>
      <ul>
        ${data.full_week_workout_plan[day]
          .map(ex => `<li>${ex}</li>`)
          .join("")}
      </ul>
    `;
  }

  workoutHTML += `</div>`;

  premiumSections.insertAdjacentHTML("beforeend", workoutHTML);
}

      premiumSections.style.display = "block";

      if (regenBtn) regenBtn.style.display = "inline-block";
    }

  } catch (err) {
    console.error(err);
    statusEl.textContent = "Something went wrong generating your plan.";
  }

  if (generateBtn) generateBtn.disabled = false;
  if (regenBtn) regenBtn.disabled = false;
}
</script>
<!-- PREMIUM SECTIONS -->

<!-- ========================= -->
<!-- Stripe Checkout (LEGACY ‚Äì KEPT) -->
<!-- ========================= -->
<script>
const params = new URLSearchParams(window.location.search);
const sessionId = params.get("session_id");

if (sessionId) {

  fetch("/.netlify/functions/getCustomerFromSession", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sessionId })
  })
  .then(res => res.json())
  .then(async data => {

    if (!data.customerId) return;

    const supabase = window.supabaseClient;

    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return;

    await supabase
      .from("profiles")
      .update({ premium_status: true })
      .eq("id", user.id);

    window.location.href = "/results.html";

  })
  .catch(err => console.error(err));
}
</script>
<script>
  function unlockPremiumUI() {

  document.body.classList.add("is-premium");

  const overlay = document.querySelector(".premium-locked-overlay");
  const badge = document.getElementById("premium-badge");
  const reonboardBtn = document.getElementById("regenBtn");

  if (overlay) overlay.style.display = "none";
  if (badge) badge.style.display = "inline-block";
  if (reonboardBtn) reonboardBtn.style.display = "inline-block";

  
}
  function goToPremiumOnboarding() {
  localStorage.setItem("corehabit_reonboarding", "true");
  window.location.href = "/onboarding.html";
}

</script>

  
<script> 
 let selectedPlan = null;

function startPremiumFlow(planType) {
  selectedPlan = planType;

  // send user to your working premium signup page
  window.location.href = `/premium.html?plan=${planType}`;
}
</script>
  <!-- LOGIN MODAL -->
<div id="loginModal" class="auth-modal">
  <div class="auth-box">
    <h2 id="authTitle">Sign in or Create account</h2>

    <input id="loginEmail" type="email" placeholder="Email" />
    <input id="loginPassword" type="password" placeholder="Password" />

    <button onclick="submitAuth()">Continue</button>

    <p style="font-size:12px;color:#9ca3af;text-align:center;">
      New users will be automatically signed up.
    </p>
  </div>
</div>
  <script>
async function submitAuth() {

  const supabase = window.supabaseClient;

  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;

  if (!email || !password) return;

  // üî• STEP 1 ‚Äî try login first
  let { data, error } = await supabase.auth.signInWithPassword({
    email,
    password
  });

  // üî• STEP 2 ‚Äî if user doesn't exist, SIGN THEM UP
  if (error && error.message.toLowerCase().includes("invalid login")) {

    const signup = await supabase.auth.signUp({
      email,
      password
    });

    if (signup.error) {
      alert(signup.error.message);
      return;
    }

    data = signup.data;
  }

  if (error && !data?.user) {
    alert(error.message);
    return;
  }

  const userId = data.user.id;

  // üî• check premium status
  const { data: profile } = await supabase
    .from("profiles")
    .select("premium_status")
    .eq("id", userId)
    .single();

  document.getElementById("loginModal").style.display = "none";

  // Already premium
  if (profile?.premium_status === true) {
    unlockPremiumUI();
    return;
  }

  // üî• send to Stripe if upgrading
  if (selectedPlan === "monthly") {
    window.location.href = "https://buy.stripe.com/test_5kQfZifqv5eb8yI1hQ0kE01";
  } else if (selectedPlan === "annual") {
    window.location.href = "https://buy.stripe.com/test_eVq14obafgWT4isbWu0kE02";
  } else {
    location.reload();
  }
}
</script>
  <script>
function openLoginModal() {
  const modal = document.getElementById("loginModal");
  if (modal) modal.style.display = "flex";
}
</script>
</body>
</html>
