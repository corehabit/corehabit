<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Plan ‚Äî CoreHabit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<script>
  // ‚úÖ Persist Premium unlock after successful Stripe redirect
  const params = new URLSearchParams(window.location.search);

  if (params.get("premium") === "success") {
    localStorage.setItem("corehabit_premium", "true");
    

    // Optional: clean URL so it looks nice after reload
    window.history.replaceState({}, document.title, "/results.html");
  }
</script>
  <!-- Premium feature flag (TEMP ‚Äì legacy, ignored now) -->
  <script>
    window.PREMIUM_ENABLED = true;
  </script>

  <!-- Capture Stripe session_id after checkout -->
 
<script>
  const params = new URLSearchParams(window.location.search);
  const sessionId = params.get("session_id");

  if (sessionId) {
    localStorage.setItem("corehabit_session_id", sessionId);

    fetch("/.netlify/functions/getCustomerFromSession", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId })
    })
      .then(res => res.json())
      .then(data => {
        if (data.customerId) {
          localStorage.setItem("corehabit_customer_id", data.customerId);
          localStorage.setItem("corehabit_premium", "true");

          // ‚úÖ SHOW SUCCESS FEEDBACK
          const toast = document.getElementById("premium-toast");
          if (toast) {
            toast.style.opacity = "1";
            toast.style.transform = "translateY(0)";
            setTimeout(() => {
              toast.style.opacity = "0";
            }, 4000);
          }

          console.log("‚úÖ Premium unlocked:", data.customerId);
        }
      })
      .catch(err => console.error("Customer lookup failed:", err));
  }
     
</script>
     
  </script>

  <!-- Styles -->
  <link rel="stylesheet" href="./assets/styles.css">
  <link rel="stylesheet" href="./assets/premium.css">
</head>

<body
  <body class="" style="min-height:100vh;background:radial-gradient(80% 80% at 20% 10%,#1a1f35 0%,#0b0f19 60%);color:#ffffff;">
  
  <script>
  const isPremium =
    localStorage.getItem("corehabit_premium") === "true" ||
    localStorage.getItem("corehabit_customer_id");

  if (isPremium) {
    document.body.classList.add("is-premium");
  }
</script>
  min-height:100vh;
  background: radial-gradient(
    80% 80% at 20% 10%,
    #1a1f35 0%,
    #0b0f19 60%
  );
  color:#ffffff;
">

<div style="max-width:720px;margin:80px auto;padding:20px;font-family:system-ui;">

  <h1>Your Personalized Plan</h1>
  <button
  id="premiumReonboardBtn"
  style="
    margin-top:16px;
    padding:12px 20px;
    border-radius:999px;
    border:1px solid #d4af37;
    background:transparent;
    color:#d4af37;
    font-weight:700;
    cursor:pointer;
    display:none;
  "
>
  Rebuild My Plan with Premium
</button>
  
  <p style="color:#9ca3af;">
    Based on your answers, here‚Äôs your CoreHabit plan.
  </p>

  <p id="status" style="margin-top:20px;font-weight:600;"></p>

  <div style="margin-top:20px;">
    <button id="generateBtn" onclick="generatePlan()" style="
      padding:14px 22px;
      border-radius:999px;
      border:none;
      background:#7c5cff;
      color:white;
      font-weight:700;
      font-size:16px;
      cursor:pointer;
    ">
      Generate My Plan
    </button>

   
  </div>

  <div id="result" style="
    margin-top:40px;
    padding:32px;
    background:#111827;
    color:#e5e7eb;
    border-radius:20px;
    box-shadow:0 20px 40px rgba(0,0,0,0.4);
    display:none;
  "></div>

  <!-- PREMIUM -->
  <div id="premium-root" style="margin-top:56px;">

    <h2 class="premium-title">
  CoreHabit Premium
  <span
    id="premium-badge"
    style="
      margin-left:10px;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      background:#7c5cff;
      color:white;
      display:none;
    "
  >
    ACTIVE
  </span>
</h2>
    <p class="premium-subtitle">
      Everything you need to accelerate results ‚Äî personalized and adaptive.
    </p>

    <div class="premium-lock-wrapper">

      <div class="premium-card">
  <h3>üõí Grocery Lists</h3>
  <p style="color:#9ca3af;font-size:14px;margin-top:6px;">
    Budget-based weekly grocery lists auto-generated from your calories and macros.
  </p>
</div>

<div class="premium-card">
  <h3>üçΩÔ∏è 7-Day Meal Plans</h3>
  <p style="color:#9ca3af;font-size:14px;margin-top:6px;">
    A full week of meals built from your goals and preferences, updated as your plan evolves.
  </p>
</div>

<div class="premium-card">
  <h3>üèãÔ∏è Muscle Focus Workouts</h3>
  <p style="color:#9ca3af;font-size:14px;margin-top:6px;">
    Optional muscle-group focus programming that adapts your training without sacrificing balance.
  </p>
</div>

<div class="premium-card">
  <h3>üìä Macro Targets</h3>
  <p style="color:#9ca3af;font-size:14px;margin-top:6px;">
    Exact calorie and macro targets with built-in progress tracking.
  </p>
</div>

<div class="premium-card">
  <h3>üîÅ Weekly Updates</h3>
  <p style="color:#9ca3af;font-size:14px;margin-top:6px;">
    Automatic weekly plan adjustments based on your progress and check-ins.
  </p>
</div>

      <div class="premium-locked-overlay">
        <h3>Unlock CoreHabit Premium</h3>
        <p>Advanced plans, meals, groceries, and progress tracking.</p>

        <!-- ORIGINAL BUTTON (KEPT ‚Äî NOT REMOVED) -->
       <div
  style="
    display:flex;
    justify-content:center;
    gap:16px;
    margin-top:24px;
    flex-wrap:wrap;
  "
>
  <a
    href="https://buy.stripe.com/test_5kQfZifqv5eb8yI1hQ0kE01"
    class="premium-primary-btn"
    style="min-width:220px;text-align:center;"
  >
    Go Premium ‚Äî Monthly
  </a>

  <a
    href="https://buy.stripe.com/test_eVq14obafgWT4isbWu0kE02"
    class="premium-primary-btn"
    style="min-width:220px;text-align:center;"
  >
    Go Premium ‚Äî Annual
  </a>
</div>

        

      </div>

    </div>

  </div>

</div>

<div id="premium-toast" aria-live="polite">‚ú® Premium Unlocked</div>

<!-- ========================= -->
<!-- Generate Plan -->
<!-- ========================= -->
<script>
  async function generatePlan() {
    const isRegenerating =
      document.activeElement &&
      document.activeElement.id === "regenBtn";

    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const generateBtn = document.getElementById("generateBtn");
    const regenBtn = document.getElementById("regenBtn");

    generateBtn.disabled = true;
    regenBtn.disabled = true;

    statusEl.textContent = isRegenerating
      ? "Refreshing your Premium plan..."
      : "Creating your CoreHabit plan...";

    resultEl.style.display = "none";
    resultEl.innerHTML = "";

    const onboardingRaw = localStorage.getItem("corehabit_onboarding");
    if (!onboardingRaw) {
      statusEl.textContent = "No onboarding data found.";
      generateBtn.disabled = false;
      regenBtn.disabled = false;
      return;
    }

    try {
      const response = await fetch("/.netlify/functions/generatePlan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          onboarding: JSON.parse(onboardingRaw),
          isPremium:
            localStorage.getItem("corehabit_premium") === "true" ||
            !!localStorage.getItem("corehabit_customer_id")
        })
      });

      const { plan: data } = await response.json();

      resultEl.style.display = "block";
      resultEl.innerHTML = `
        <section><h2>Your CoreHabit Plan</h2><p>${data.overview}</p></section>
        <section><h3>Weekly Workout Split</h3><ul>${data.weekly_workout_split.map(d=>`<li>${d}</li>`).join("")}</ul></section>
        <section><h3>Sample Workout</h3><ul>${data.sample_workout.map(i=>`<li>${i}</li>`).join("")}</ul></section>
        <section><h3>Daily Nutrition Guidelines</h3><ul>${data.daily_nutrition_guidelines.map(i=>`<li>${i}</li>`).join("")}</ul></section>
        <section><h3>Sample Day of Eating</h3><ul>${data.sample_day_of_eating.map(i=>`<li>${i}</li>`).join("")}</ul></section>
        <section><h3>Weekly Focus Tip</h3><p>${data.weekly_focus_tip}</p></section>
      `;

      // STEP 4C ‚Äî show premium ONLY on regeneration
      if (
        isRegenerating &&
        (
          localStorage.getItem("corehabit_premium") === "true" ||
          localStorage.getItem("corehabit_customer_id")
        ) &&
        data.seven_day_meal_plan
      ) {
        document.getElementById("premium-sections").style.display = "block";
      }

      // Show regenerate button for premium users
      if (
        localStorage.getItem("corehabit_premium") === "true" ||
        localStorage.getItem("corehabit_customer_id")
      ) {
        regenBtn.style.display = "inline-block";
      }

    } catch (err) {
      console.error(err);
      statusEl.textContent = "Something went wrong generating your plan.";
    }

    generateBtn.disabled = false;
    regenBtn.disabled = false;
  }

  // STEP 4B ‚Äî hide premium sections on page load
  const premiumSections = document.getElementById("premium-sections");
  if (premiumSections) premiumSections.style.display = "none";
</script>
<!-- PREMIUM SECTIONS -->
<section id="premium-sections" style="display:none;">

  <div class="premium-card">
    <h3>7-Day Meal Plan</h3>
    <ul id="seven-day-meal-plan"></ul>
  </div>

  <div class="premium-card">
    <h3>Grocery List</h3>
    <ul id="grocery-list"></ul>
  </div>

  <div class="premium-card">
    <h3>Weekly Check-In</h3>
    <p id="weekly-check-in"></p>
  </div>

  <div class="premium-card">
    <h3>Advanced Training Notes</h3>
    <p id="advanced-training-notes"></p>
  </div>

</section>
<!-- ========================= -->
<!-- Stripe Checkout (LEGACY ‚Äì KEPT) -->
<!-- ========================= -->
<script>
  async function startCheckout() {
    try {
      const res = await fetch("/.netlify/functions/createCheckoutSession", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          priceId: "price_1Suo3PL0p80VWf6ll3JE5WqS"
        })
      });

      const data = await res.json();
      if (data.url) {
        window.location.href = data.url;
      } else {
        alert("Failed to start checkout.");
      }
    } catch (err) {
      console.error("Checkout error:", err);
      alert("Checkout failed.");
    }
  }
</script>
<script>
  const isPremium =
    localStorage.getItem("corehabit_premium") === "true" ||
    localStorage.getItem("corehabit_customer_id");

  const reonboardBtn = document.getElementById("premiumReonboardBtn");

  if (isPremium && reonboardBtn) {
    reonboardBtn.style.display = "inline-block";
  }

  if (reonboardBtn) {
    reonboardBtn.addEventListener("click", () => {
      localStorage.setItem("corehabit_reonboarding", "true");
      window.location.href = "/onboarding.html";
    });
  }
</script>
 
</body>
</html>
